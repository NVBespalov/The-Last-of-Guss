# Аутентификация в API

## Обзор

Данный документ описывает механизмы аутентификации и авторизации, используемые в API системы подсчета очков, включая JWT-токены, OAuth 2.0 и многофакторную аутентификацию.

## Методы аутентификации

### JWT-токены

Основной метод аутентификации в API - использование JSON Web Tokens (JWT).

#### Процесс аутентификации:

1. Клиент отправляет учетные данные на эндпоинт `/api/v1/auth/login`
2. Сервер проверяет учетные данные и возвращает пару токенов:
   - **Access токен**: короткоживущий токен (30 минут) для доступа к API
   - **Refresh токен**: долгоживущий токен (7 дней) для обновления access токена

#### Структура JWT токена:

```
header.payload.signature
``` 

**Пример заголовка (header)**:
```
json { "alg": "HS256", "typ": "JWT" }
``` 

**Пример полезной нагрузки (payload)**:
```json
{
  "sub": "1234567890",
  "name": "John Doe",
  "roles": ["user"],
  "iat": 1516239022,
  "exp": 1516240822
}
```
```
#### Использование JWT токенов:
Access токен должен быть включен в каждый запрос API в заголовке Authorization:
``` 
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```
#### Обновление токенов:
Когда access токен истекает, клиент может получить новую пару токенов, отправив refresh токен на эндпоинт `/api/v1/auth/refresh`:
``` http
POST /api/v1/auth/refresh
Content-Type: application/json

{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```
### OAuth 2.0
Система поддерживает аутентификацию через внешних провайдеров OAuth 2.0.
#### Поддерживаемые провайдеры:
- Google
- Facebook
- GitHub
- Microsoft

#### Процесс OAuth 2.0 аутентификации:
1. Клиент перенаправляет пользователя на эндпоинт `/api/v1/auth/oauth/{provider}`
2. Пользователь аутентифицируется у провайдера и даёт разрешение на доступ
3. Провайдер перенаправляет пользователя обратно с кодом авторизации
4. Сервер обменивает код на токен доступа провайдера
5. Сервер проверяет токен и создает собственные JWT токены для пользователя

#### Пример запроса OAuth:
``` 
GET /api/v1/auth/oauth/google?redirect_uri=https://app.scoring-system.com/callback&state=random_state
```
### Многофакторная аутентификация (MFA)
Для административных аккаунтов поддерживается многофакторная аутентификация.
#### Поддерживаемые методы MFA:
- Приложения-аутентификаторы (Google Authenticator, Microsoft Authenticator)
- SMS-коды
- Email-коды

#### Процесс MFA аутентификации:
1. Пользователь авторизуется с помощью логина и пароля
2. Система проверяет, включена ли MFA для пользователя
3. Если MFA включена, система запрашивает дополнительный код подтверждения
4. Пользователь вводит код
5. При успешной проверке система выдает JWT токены

#### Пример запроса MFA:
``` http
POST /api/v1/auth/mfa/verify
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

{
  "code": "123456",
  "method": "app"
}
```
## Управление токенами
### Безопасность токенов
- Access токены имеют короткое время жизни (30 минут)
- Refresh токены хранятся в базе данных и могут быть отозваны
- Токены подписываются с использованием алгоритма HS256 или RS256
- При изменении критических данных пользователя все токены автоматически отзываются

### Отзыв токенов
Токены могут быть отозваны в следующих случаях:
- Пользователь выходит из системы (logout)
- Администратор отзывает доступ пользователя
- Обнаружена подозрительная активность
- Изменен пароль пользователя

Для отзыва токенов используется эндпоинт:
``` http
POST /api/v1/auth/revoke
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

{
  "token_type": "refresh",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```
## Ролевая модель и права доступа
### Доступные роли:
- **superadmin**: полный доступ ко всем функциям системы
- **admin**: управление пользователями и настройками
- **moderator**: управление игровыми раундами
- **user**: базовый доступ к функциям системы
- **guest**: ограниченный доступ только для просмотра

### Проверка прав доступа:
API проверяет права доступа на основе:
- Роли пользователя
- Конкретных разрешений, назначенных пользователю
- Владения ресурсом (например, пользователь может редактировать только свой профиль)

## Безопасность аутентификации
### Защита от атак:
- **Ограничение попыток входа**: Временная блокировка после нескольких неудачных попыток
- **CAPTCHA**: Активируется после подозрительной активности
- **Мониторинг**: Необычные шаблоны аутентификации отслеживаются
- **Проверка IP**: Уведомление пользователя при входе с нового устройства или IP-адреса

### Журналирование:
Все действия, связанные с аутентификацией, журналируются:
- Успешные и неудачные попытки входа
- Обновление токенов
- Отзыв токенов
- Изменение настроек безопасности

## Пример последовательности аутентификации
1. **Вход пользователя**:
``` http
POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "user@example.com",
  "password": "secure_password"
}
```
1. **Получение токенов**:
``` json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in": 1800,
  "token_type": "Bearer"
}
```
1. **Доступ к защищенному ресурсу**:
``` http
GET /api/v1/users/me
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```
1. **Обновление токена после истечения срока**:
``` http
POST /api/v1/auth/refresh
Content-Type: application/json

{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```
1. **Выход из системы**:
``` http
POST /api/v1/auth/logout
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```
## Рекомендации для клиентов
- Храните токены в безопасном месте (HttpOnly cookies для веб-приложений)
- Реализуйте автоматическое обновление токенов при их истечении
- Отправляйте запрос на logout при выходе пользователя из приложения
- Всегда используйте HTTPS для передачи токенов
- Реализуйте обработку ошибок 401 Unauthorized для перенаправления на страницу входа
